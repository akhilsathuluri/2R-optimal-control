function [s1,s2,s3,s4,cs1,cs2,cs3,cs4,i1,i2,h1] = topt23(x10,x20,x30,x40,p10,p20,p30,p40,tf)
m1 = 29.58;
m2 = 15;
l1 = 0.4;
l2 = 0.25;
I1 = 0.416739;
I2 = 0.205625;
M1 = 25;
M2 = 9;
ma = 0;
mb = 6;
h = 10^-6;
n = tf/h;

x1 = x10;
x2 = x20;
x3 = x30;
x4 = x40;
p1 = p10;
p2 = p20;
p3 = p30;
p4 = p40;



c1 = 0.25*m1*l1^2 + I1 + (m2 + ma + mb)*l1^2;
c2 = m2*0.25*l2^2 + I2 + mb*l2^2;
c3 = (m2*l2*0.5 + mb*l2)*l1;

for i=1:n+1
    
tmp1 = x1;
tmp2 = x2;
tmp3 = x3;
tmp4 = x4;
tmp5 = p1;
tmp6 = p2;
tmp7 = p3;
tmp8 = p4;   

   
a11 = c1 + c2 + 2*c3*cos(x3);
a12 = c2 +c3*cos(x3);
a13 = c3*sin(x3);
a22 = c2;
del = a11*a22 - a12^2;
c11 = 0;
c12 = 0;
c21 = a22/del;
c22 = -a12/del;
c31 = 0;
c32 = 0;
c41 = -a12/del;
c42 = a11/del;
a1 = x2;
a2 = (a13/del)*(a22*(2*x2+x4)*x4+a12*x2^2);
a3 = x4;
a4 = (-a13/del)*(a12*(2*x2+x4)*x4+a11*x2^2);
G1 = (1/del)*(p2*a22-p4*a12);
G2 = (1/del)*(-1*p2*a12+p4*a11);
if G1 < 0
    u1 = M1;
else
    u1 = -M1;
end

if G2 < 0
    u2 = M2;
else
    u2 = -M2;
end
fx1 = a1+c11*u1+c12*u2;
fx2 = a2+c21*u1+c22*u2;
fx3 = a3+c31*u1+c32*u2;
fx4 = a4+c41*u1+c42*u2;
fp1 = 0;
fp2 = -p1-(1.35*p2*(1.63*x4 + 2*x2*(0.815 + 1.35*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) +(1.35*p4*(2*x4*(0.815 + 1.35*cos(x3)) + 2*x2*(5.774939000000002 + 2.7*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2);
fp3 = (-p2)*((1.35*cos(x3)*(0.815*x4*(2*x2 + x4) + x2^2*(0.815 + 1.35*cos(x3))))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) - (2.9706750000000004*u1*cos(x3)*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (3.6450000000000005*u2*cos(x3)*(0.815 + 1.35*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (1.35*u2*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) - (1.8225000000000002*x2^2*sin(x3)^2)/(4.042350285000001 -1.8225000000000002*cos(x3)^2) - (4.920750000000001*cos(x3)*(0.815*x4*(2*x2 + x4) + x2^2*(0.815 + 1.35*cos(x3)))*sin(x3)^2)/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2) - p4*(-((1.35*cos(x3)*(x4*(2*x2 + x4)*(0.815 + 1.35*cos(x3)) + x2^2*(5.774939000000002 + 2.7*cos(x3))))/(4.042350285000001 -1.8225000000000002*cos(x3)^2)) + (3.6450000000000005*u1*cos(x3)*(0.815 + 1.35*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 - (3.6450000000000005*u2*cos(x3)*(5.774939000000002 + 2.7*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (1.35*u1*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) -  (2.7*u2*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) + (4.920750000000001*cos(x3)*(x4*(2*x2 + x4)*(0.815 + 1.35*cos(x3)) + x2^2*(5.774939000000002 + 2.7*cos(x3)))*sin(x3)^2)/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 - (1.35*sin(x3)*(-2.7*x2^2*sin(x3) - 1.35*x4*(2*x2 + x4)*sin(x3)))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2));
fp4 = -p3 - (1.35*p2*(0.815*x4 + 0.815*(2*x2 + x4))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) + (1.35*p4*(x4*(0.815 + 1.35*cos(x3)) + (2*x2 + x4)*(0.815 + 1.35*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2);       
x1 = tmp1+h*fx1*0.5;
x2 = tmp2+h*fx2*0.5;
x3 = tmp3+h*fx3*0.5;
x4 = tmp4+h*fx4*0.5;
p1 = tmp5+h*fp1*0.5;
p2 = tmp6+h*fp2*0.5;
p3 = tmp7+h*fp3*0.5;
p4 = tmp8+h*fp4*0.5;



   

   
a11 = c1 + c2 + 2*c3*cos(x3);
a12 = c2 +c3*cos(x3);
a13 = c3*sin(x3);
a22 = c2;
del = a11*a22 - a12^2;
c11 = 0;
c12 = 0;
c21 = a22/del;
c22 = -a12/del;
c31 = 0;
c32 = 0;
c41 = -a12/del;
c42 = a11/del;
a1 = x2;
a2 = (a13/del)*(a22*(2*x2+x4)*x4+a12*x2^2);
a3 = x4;
a4 = (-a13/del)*(a12*(2*x2+x4)*x4+a11*x2^2);
G1 = (1/del)*(p2*a22-p4*a12);
G2 = (1/del)*(-1*p2*a12+p4*a11);
if G1 < 0
    u1 = M1;
else
    u1 = -1*M1;
end

if G2 < 0
    u2 = M2;
else
    u2 = -M2;
end
fx11 = a1+c11*u1+c12*u2;
fx21 = a2+c21*u1+c22*u2;
fx31 = a3+c31*u1+c32*u2;
fx41 = a4+c41*u1+c42*u2;
fp11 = 0;
fp21 = -p1-(1.35*p2*(1.63*x4 + 2*x2*(0.815 + 1.35*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) +(1.35*p4*(2*x4*(0.815 + 1.35*cos(x3)) + 2*x2*(5.774939000000002 + 2.7*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2);
fp31 = (-p2)*((1.35*cos(x3)*(0.815*x4*(2*x2 + x4) + x2^2*(0.815 + 1.35*cos(x3))))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) - (2.9706750000000004*u1*cos(x3)*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (3.6450000000000005*u2*cos(x3)*(0.815 + 1.35*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (1.35*u2*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) - (1.8225000000000002*x2^2*sin(x3)^2)/(4.042350285000001 -1.8225000000000002*cos(x3)^2) - (4.920750000000001*cos(x3)*(0.815*x4*(2*x2 + x4) + x2^2*(0.815 + 1.35*cos(x3)))*sin(x3)^2)/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2) - p4*(-((1.35*cos(x3)*(x4*(2*x2 + x4)*(0.815 + 1.35*cos(x3)) + x2^2*(5.774939000000002 + 2.7*cos(x3))))/(4.042350285000001 -1.8225000000000002*cos(x3)^2)) + (3.6450000000000005*u1*cos(x3)*(0.815 + 1.35*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 - (3.6450000000000005*u2*cos(x3)*(5.774939000000002 + 2.7*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (1.35*u1*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) -  (2.7*u2*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) + (4.920750000000001*cos(x3)*(x4*(2*x2 + x4)*(0.815 + 1.35*cos(x3)) + x2^2*(5.774939000000002 + 2.7*cos(x3)))*sin(x3)^2)/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 - (1.35*sin(x3)*(-2.7*x2^2*sin(x3) - 1.35*x4*(2*x2 + x4)*sin(x3)))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2));
fp41 = -p3 - (1.35*p2*(0.815*x4 + 0.815*(2*x2 + x4))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) + (1.35*p4*(x4*(0.815 + 1.35*cos(x3)) + (2*x2 + x4)*(0.815 + 1.35*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2);       
x1 = tmp1+h*fx11*0.5;
x2 = tmp2+h*fx21*0.5;
x3 = tmp3+h*fx31*0.5;
x4 = tmp4+h*fx41*0.5;
p1 = tmp5+h*fp11*0.5;
p2 = tmp6+h*fp21*0.5;
p3 = tmp7+h*fp31*0.5;
p4 = tmp8+h*fp41*0.5;



   

   
a11 = c1 + c2 + 2*c3*cos(x3);
a12 = c2 +c3*cos(x3);
a13 = c3*sin(x3);
a22 = c2;
del = a11*a22 - a12^2;
c11 = 0;
c12 = 0;
c21 = a22/del;
c22 = -a12/del;
c31 = 0;
c32 = 0;
c41 = -a12/del;
c42 = a11/del;
a1 = x2;
a2 = (a13/del)*(a22*(2*x2+x4)*x4+a12*x2^2);
a3 = x4;
a4 = (-a13/del)*(a12*(2*x2+x4)*x4+a11*x2^2);
G1 = (1/del)*(p2*a22-p4*a12);
G2 = (1/del)*(-1*p2*a12+p4*a11);
if G1 < 0
   u1 = M1;
else
   u1 = -1*M1;
end

if G2 < 0
    u2 = M2;
else
    u2 = -M2;
end
fx12 = a1+c11*u1+c12*u2;
fx22 = a2+c21*u1+c22*u2;
fx32 = a3+c31*u1+c32*u2;
fx42 = a4+c41*u1+c42*u2;
fp12 = 0;
fp22 = -p1-(1.35*p2*(1.63*x4 + 2*x2*(0.815 + 1.35*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) +(1.35*p4*(2*x4*(0.815 + 1.35*cos(x3)) + 2*x2*(5.774939000000002 + 2.7*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2);
fp32 = (-p2)*((1.35*cos(x3)*(0.815*x4*(2*x2 + x4) + x2^2*(0.815 + 1.35*cos(x3))))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) - (2.9706750000000004*u1*cos(x3)*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (3.6450000000000005*u2*cos(x3)*(0.815 + 1.35*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (1.35*u2*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) - (1.8225000000000002*x2^2*sin(x3)^2)/(4.042350285000001 -1.8225000000000002*cos(x3)^2) - (4.920750000000001*cos(x3)*(0.815*x4*(2*x2 + x4) + x2^2*(0.815 + 1.35*cos(x3)))*sin(x3)^2)/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2) - p4*(-((1.35*cos(x3)*(x4*(2*x2 + x4)*(0.815 + 1.35*cos(x3)) + x2^2*(5.774939000000002 + 2.7*cos(x3))))/(4.042350285000001 -1.8225000000000002*cos(x3)^2)) + (3.6450000000000005*u1*cos(x3)*(0.815 + 1.35*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 - (3.6450000000000005*u2*cos(x3)*(5.774939000000002 + 2.7*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (1.35*u1*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) -  (2.7*u2*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) + (4.920750000000001*cos(x3)*(x4*(2*x2 + x4)*(0.815 + 1.35*cos(x3)) + x2^2*(5.774939000000002 + 2.7*cos(x3)))*sin(x3)^2)/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 - (1.35*sin(x3)*(-2.7*x2^2*sin(x3) - 1.35*x4*(2*x2 + x4)*sin(x3)))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2));
fp42 = -p3 - (1.35*p2*(0.815*x4 + 0.815*(2*x2 + x4))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) + (1.35*p4*(x4*(0.815 + 1.35*cos(x3)) + (2*x2 + x4)*(0.815 + 1.35*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2);       
x1 = tmp1+h*fx12;
x2 = tmp2+h*fx22;
x3 = tmp3+h*fx32;
x4 = tmp4+h*fx42;
p1 = tmp5+h*fp12;
p2 = tmp6+h*fp22;
p3 = tmp7+h*fp32;
p4 = tmp8+h*fp42;




   

   
a11 = c1 + c2 + 2*c3*cos(x3);
a12 = c2 +c3*cos(x3);
a13 = c3*sin(x3);
a22 = c2;
del = a11*a22 - a12^2;
c11 = 0;
c12 = 0;
c21 = a22/del;
c22 = -a12/del;
c31 = 0;
c32 = 0;
c41 = -a12/del;
c42 = a11/del;
a1 = x2;
a2 = (a13/del)*(a22*(2*x2+x4)*x4+a12*x2^2);
a3 = x4;
a4 = (-a13/del)*(a12*(2*x2+x4)*x4+a11*x2^2);
G1 = (1/del)*(p2*a22-p4*a12);
G2 = (1/del)*(-1*p2*a12+p4*a11);
if G1 < 0
    u1 = M1;
else
    u1 = -1*M1;
end

if G2 < 0
    u2 = M2;
   else
   u2 = -M2;
end
fx13 = a1+c11*u1+c12*u2;
fx23 = a2+c21*u1+c22*u2;
fx33 = a3+c31*u1+c32*u2;
fx43 = a4+c41*u1+c42*u2;
fp13 = 0;
fp23 = -p1-(1.35*p2*(1.63*x4 + 2*x2*(0.815 + 1.35*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) +(1.35*p4*(2*x4*(0.815 + 1.35*cos(x3)) + 2*x2*(5.774939000000002 + 2.7*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2);
fp33 = (-p2)*((1.35*cos(x3)*(0.815*x4*(2*x2 + x4) + x2^2*(0.815 + 1.35*cos(x3))))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) - (2.9706750000000004*u1*cos(x3)*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (3.6450000000000005*u2*cos(x3)*(0.815 + 1.35*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (1.35*u2*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) - (1.8225000000000002*x2^2*sin(x3)^2)/(4.042350285000001 -1.8225000000000002*cos(x3)^2) - (4.920750000000001*cos(x3)*(0.815*x4*(2*x2 + x4) + x2^2*(0.815 + 1.35*cos(x3)))*sin(x3)^2)/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2) - p4*(-((1.35*cos(x3)*(x4*(2*x2 + x4)*(0.815 + 1.35*cos(x3)) + x2^2*(5.774939000000002 + 2.7*cos(x3))))/(4.042350285000001 -1.8225000000000002*cos(x3)^2)) + (3.6450000000000005*u1*cos(x3)*(0.815 + 1.35*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 - (3.6450000000000005*u2*cos(x3)*(5.774939000000002 + 2.7*cos(x3))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 + (1.35*u1*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) -  (2.7*u2*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) + (4.920750000000001*cos(x3)*(x4*(2*x2 + x4)*(0.815 + 1.35*cos(x3)) + x2^2*(5.774939000000002 + 2.7*cos(x3)))*sin(x3)^2)/(4.042350285000001 - 1.8225000000000002*cos(x3)^2)^2 - (1.35*sin(x3)*(-2.7*x2^2*sin(x3) - 1.35*x4*(2*x2 + x4)*sin(x3)))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2));
fp43 = -p3 - (1.35*p2*(0.815*x4 + 0.815*(2*x2 + x4))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2) + (1.35*p4*(x4*(0.815 + 1.35*cos(x3)) + (2*x2 + x4)*(0.815 + 1.35*cos(x3)))*sin(x3))/(4.042350285000001 - 1.8225000000000002*cos(x3)^2);       
x1 = tmp1+(1/6)*(fx1+2*fx11+2*fx12+fx13)*h;
x2 = tmp2+(1/6)*(fx2+2*fx21+2*fx22+fx23)*h;
x3 = tmp3+(1/6)*(fx3+2*fx31+2*fx32+fx33)*h;
x4 = tmp4+(1/6)*(fx4+2*fx41+2*fx42+fx43)*h;
p1 = tmp5+(1/6)*(fp1+2*fp11+2*fp12+fp13)*h;
p2 = tmp6+(1/6)*(fp2+2*fp21+2*fp22+fp23)*h;
p3 = tmp7+(1/6)*(fp3+2*fp31+2*fp32+fp33)*h;
p4 = tmp8+(1/6)*(fp4+2*fp41+2*fp42+fp43)*h;

s1(i) = x1;
s2(i) = x2;
s3(i) = x3;
s4(i) = x4;
cs1(i) = p1;
cs2(i) = p2;
cs3(i) = p3;
cs4(i) = p4;
i1(i) = u1;
i2(i) =u2;

h1(i) = 1 + p1*(a1 + c11*u1 + c12*u2) + p2*(a2 + c21*u1 + c22*u2)+ p3*(a3 + c31*u1 + c32*u2) + p4*(a4 + c41*u1 + c42*u2);

end

end